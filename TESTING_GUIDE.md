# Руководство по тестированию TARS (Фаза 1 - MVP)

## Текущий статус: Фаза 1 — MVP (Read Only)

На данном этапе реализованы **базовые функции чтения данных**. Система может:
- ✅ Подключаться к Telegram
- ✅ Подключаться к базе данных PostgreSQL
- ✅ Запрашивать данные из Яндекс.Директ API
- ✅ Отправлять запросы к AI (OpenRouter)
- ✅ Отвечать на команды в Telegram

## Что ожидать от текущего тестирования

### ✅ Должно работать:

1. **Telegram Bot — базовые команды:**
   - `/start` — приветственное сообщение с меню
   - `/help` — справка по командам
   - `/campaigns` — список кампаний (если они есть в БД)
   - Inline-кнопки в меню

2. **База данных:**
   - Подключение к PostgreSQL
   - Создание таблиц (миграции)
   - Сохранение данных

3. **Логирование:**
   - Логи в консоль (docker logs)
   - Логи в файлы (`logs/`)
   - Отладочные логи запросов к API

### ⚠️ Ожидаемые ограничения:

1. **Команда `/report` может не работать, если:**
   - Нет активных кампаний в Яндекс.Директ
   - Нет данных за вчерашний день
   - Токены Яндекса не настроены или истекли
   - **Это нормально на этапе MVP!**

2. **Некоторые кнопки могут показывать "будет доступно в следующей версии":**
   - Предложения
   - Настройки
   - Это заглушки для будущих фаз

3. **Ошибки Telegram "query is too old":**
   - Это **нормально** — происходит, когда бот долго обрабатывает запрос
   - Telegram ждёт ответ на callback максимум 30 секунд
   - Если запрос к Яндексу или AI занимает больше времени, Telegram отменяет callback
   - **Не критично**, основная функциональность работает

## Типичные ошибки и их значение

### 1. TimeoutError / "query is too old"

```
error_code: 400
description: "Bad Request: query is too old and response timeout expired"
```

**Что это значит:**
- Бот слишком долго обрабатывал нажатие кнопки (>30 сек)
- Обычно происходит при запросе к Яндекс.Директ или AI

**Это нормально?**
- ✅ Да, на этапе MVP это ожидаемо
- Запросы к внешним API могут быть медленными
- В будущем добавим асинхронную обработку

**Как проверить, что всё работает:**
- Посмотрите логи — там будет видно, что запрос выполнился
- Данные сохранились в БД
- Просто Telegram не дождался ответа на callback

### 2. "No campaigns found" / "Кампании не найдены"

**Что это значит:**
- В базе данных пока нет кампаний
- Или не удалось получить их из Яндекс.Директ

**Это нормально?**
- ✅ Да, если вы только запустили систему
- Кампании появятся после первого успешного запроса к Яндексу

**Как исправить:**
- Проверьте токены Яндекса в `.env`
- Убедитесь, что в Яндекс.Директ есть активные кампании
- Попробуйте команду `/report` — она запросит данные

### 3. Ошибки доступа к Яндекс.Директ

```
401 Unauthorized
или
403 Forbidden
```

**Что это значит:**
- Неправильные токены доступа
- Или токен истёк

**Как исправить:**
- Проверьте `YANDEX_ACCESS_TOKEN` в `.env`
- Получите новые токены (см. [`SETUP_GUIDE.md`](SETUP_GUIDE.md:1))

## Как правильно тестировать Фазу 1

### Шаг 1: Проверка базовой работоспособности

```bash
# 1. Проверить, что контейнеры запущены
docker compose ps

# Должно быть:
# tars-app      Up
# tars-postgres Up (healthy)
```

### Шаг 2: Проверка Telegram бота

1. Откройте бота в Telegram
2. Отправьте `/start`
3. **Ожидаемый результат:**
   - Бот отвечает приветственным сообщением
   - Показывает меню с кнопками
   - ✅ Если это работает — базовая интеграция OK

### Шаг 3: Проверка базы данных

```bash
# Подключиться к PostgreSQL
docker compose exec postgres psql -U tars -d tars

# Проверить таблицы
\dt

# Должны быть таблицы:
# campaigns, daily_stats, keywords, search_queries, 
# change_log, conversations, messages, proposals, 
# knowledge_base, raw_api_responses, etc.

# Выход
\q
```

### Шаг 4: Проверка логов

```bash
# Смотреть логи в реальном времени
docker compose logs -f app

# Что искать:
# ✅ "Application started successfully"
# ✅ "Database connected"
# ✅ "Telegram Bot started"
# ✅ "Scheduler started"
```

### Шаг 5: Тестирование команд

Попробуйте в Telegram:

1. **`/start`** — должно работать ✅
2. **`/help`** — должно работать ✅
3. **`/campaigns`** — может показать "не найдено" (нормально)
4. **`/report`** — может упасть с timeout (нормально, если нет данных)
5. **`/ask Привет`** — должно ответить через AI ✅

## Что НЕ должно работать на Фазе 1

❌ **Выполнение действий в Яндекс.Директ:**
- Добавление минус-слов
- Изменение ставок
- Остановка кампаний
- **Это будет в Фазе 3**

❌ **Предложения новых кампаний:**
- Генерация инструкций
- Обсуждение предложений
- **Это будет в Фазе 4**

❌ **Продвинутая работа с контекстом:**
- Переключение между кампаниями
- Длинные диалоги с памятью
- **Это будет в Фазе 2**

## Критерии успешного прохождения Фазы 1

### ✅ Минимальные требования (MVP):

1. **Telegram бот отвечает на `/start`**
2. **База данных создана и доступна**
3. **Логи пишутся в файлы**
4. **Нет критических ошибок при запуске**

### ✅ Желательно (но не обязательно):

1. Успешный запрос к Яндекс.Директ API
2. Успешный запрос к OpenRouter (AI)
3. Сохранение данных в БД
4. Генерация отчёта

## Следующие шаги

После успешного прохождения Фазы 1:

1. **Фаза 2: Диалог и память**
   - Полноценные диалоги с AI
   - Сохранение истории
   - Переключение контекстов

2. **Фаза 3: Действия**
   - Выполнение изменений в Яндекс.Директ
   - Подтверждение через кнопки
   - Логирование изменений

3. **Фаза 4: Предложения**
   - Генерация новых кампаний
   - База знаний
   - Продвинутый анализ

## Полезные команды для отладки

```bash
# Перезапустить приложение
docker compose restart app

# Посмотреть все логи
docker compose logs app | less

# Посмотреть только ошибки
docker compose logs app 2>&1 | grep -i error

# Проверить переменные окружения
docker compose exec app env | grep -E "TELEGRAM|YANDEX|OPENROUTER"

# Очистить всё и начать заново
docker compose down -v
docker compose up -d
docker compose exec app npm run migrate
```

## Вопросы и проблемы

Если что-то не работает:

1. **Проверьте логи:** `docker compose logs app --tail=100`
2. **Проверьте `.env`:** все ли токены заполнены?
3. **Проверьте статус:** `docker compose ps`
4. **Перезапустите:** `docker compose restart app`

Помните: **на Фазе 1 многие функции ещё не реализованы** — это нормально!
