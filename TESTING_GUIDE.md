# Руководство по тестированию TARS (Alpha - Async + RAG)

## Текущий статус: Alpha (Фаза 2+)

Система переведена на асинхронную архитектуру. Реализовано:

- ✅ **Очереди задач (BullMQ + Redis):** Обработка тяжелых запросов в фоне
- ✅ **Векторный поиск (RAG):** Умный поиск по базе знаний
- ✅ **Валидация данных (Zod):** Защита от ошибок API Яндекса
- ✅ **Безопасность действий:** Проверка срока действия кнопок (TTL)

## Что ожидать от тестирования

### ✅ Должно работать быстро и без таймаутов:

1. **Telegram Bot:**
   - Команды `/report`, `/week`, `/ask` должны отвечать мгновенно: _"⏳ Запрос добавлен в очередь..."_.
   - Результат должен приходить вторым сообщением спустя некоторое время.
   - **Ошибки "query is too old" теперь недопустимы!**

2. **База данных:**
   - Используется `pgvector` для эмбеддингов.
   - Миграции должны проходить успешно (`npm run migrate`).

3. **Тесты:**
   - В проекте появились Unit-тесты.
   - Запуск: `npm test`

### ⚠️ Возможные проблемы:

1. **Если бот не отвечает на `/report`:**
   - Проверьте, запущен ли Redis: `docker compose ps`
   - Проверьте логи воркеров: `docker compose logs -f app` (ищите "Processing report job")

2. **Если AI отвечает невпопад:**
   - Возможно, база знаний пуста. Попробуйте `/load_context`.

## Типичные ошибки

### 1. TimeoutError / "query is too old" - ❌ БОЛЬШЕ НЕ НОРМА

Если вы видите эту ошибку — **система неисправна**.
Это значит, что очередь переполнена, Redis упал, или воркер завис. Сообщите разработчику.

### 2. "Action expired"

При нажатии на старую кнопку (вчерашнюю) бот ответит:
_"Срок действия этого предложения истёк"_
Это **нормально** и является новой функцией безопасности.

## Как тестировать

### Шаг 1: Проверка инфраструктуры

```bash
docker compose ps
# Должны быть: app, postgres (pgvector), redis
```

### Шаг 2: Запуск тестов

```bash
# Внутри контейнера или локально (если есть node_modules)
npm test
```

### Шаг 3: Проверка асинхронности

1. Отправьте `/ask Почему упал CTR?`
2. Бот должен **сразу** ответить: "⏳ Думаю..."
3. Через 5-15 секунд должен прийти развернутый ответ.

### Шаг 4: Проверка валидации

Логи будут содержать ошибки валидации Zod, если Яндекс пришлет некорректные данные. Это не положит бота, но будет видно в `logs/error.log`.

## Полезные команды

```bash
# Запуск тестов
npm test

# Пересборка с новыми зависимостями
docker compose up -d --build

# Проверка очереди в Redis (через CLI)
docker compose exec redis redis-cli llen bull:messages:wait
```
